<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>coldout — photo archive</title>
  <style>
    html { scroll-behavior: smooth; }
    body { background-color: #000; overflow-x: hidden; }
    section { scroll-margin-top: 100px; }
    
    .reveal {
      opacity: 0;
      transform: translateY(50px);
      transition: all 1.2s cubic-bezier(0.2, 1, 0.3, 1);
    }
    .reveal.active { opacity: 1; transform: translateY(0); }

    /* Masonry сетка через колонки */
    .masonry-grid { 
      column-count: 2; 
      column-gap: 1rem;
    }
    @media (min-width: 768px) { .masonry-grid { column-count: 3; } }
    @media (min-width: 1024px) { .masonry-grid { column-count: 4; } }

    .photo-item { 
      break-inside: avoid;
      margin-bottom: 1rem;
      background: #050505;
      position: relative;
    }

    .photo-item img {
      width: 100%;
      height: auto; /* Оригинальное соотношение сторон */
      display: block;
    }

    #lightbox {
      display: none; position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
      cursor: zoom-out; align-items: center; justify-content: center;
    }
    #lightbox.active { display: flex; }
    #lightbox img { max-width: 90%; max-height: 90%; object-fit: contain; }

    /* Круг загрузки в левом нижнем углу */
    #loader-container {
      position: fixed; bottom: 30px; left: 30px;
      width: 40px; height: 40px; z-index: 150;
      display: flex; align-items: center; justify-content: center;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }
    .progress-ring__circle {
      transition: stroke-dashoffset 0.3s linear;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #18181b; }
  </style>
</head>
<body class="text-zinc-400 font-sans selection:bg-zinc-800">

  <nav class="fixed top-0 left-0 w-full px-6 py-4 md:px-10 flex flex-row justify-between items-center z-50 bg-black/60 backdrop-blur-md border-b border-white/5">
    <div class="text-white tracking-[0.2em] lowercase font-light text-sm md:text-base cursor-pointer" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">coldout</div>
    <div id="nav-years" class="flex items-center space-x-4 md:space-x-6 text-[10px] tracking-[0.1em] lowercase font-light overflow-x-auto"></div>
  </nav>

  <div id="loader-container" class="opacity-0">
    <svg width="40" height="40">
      <circle class="text-zinc-900" stroke="currentColor" stroke-width="1.5" fill="transparent" r="18" cx="20" cy="20"/>
      <circle id="progress-circle" class="text-white progress-ring__circle" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="transparent" r="18" cx="20" cy="20"/>
    </svg>
  </div>

  <div id="lightbox" onclick="closeLightbox()">
    <img id="lightbox-img" src="" alt="">
  </div>

  <div id="gallery-overlay" class="hidden fixed inset-0 bg-black z-[100] overflow-y-auto p-6 md:p-20">
    <div class="flex justify-between items-baseline mb-16 max-w-[1600px] mx-auto">
      <h2 id="gallery-title" class="text-white text-3xl font-thin lowercase tracking-tighter"></h2>
      <button onclick="closeGallery()" class="text-zinc-600 hover:text-white uppercase text-[9px] tracking-[0.3em] transition-colors border-b border-zinc-800 hover:border-white pb-1">close</button>
    </div>
    <div id="gallery-grid" class="masonry-grid max-w-[1600px] mx-auto pb-20"></div>
  </div>

  <main id="main-content" class="pt-24 px-6 md:px-20 max-w-[1600px] mx-auto">
    <div id="years-container"></div>
  </main>

  <script>
    const GITHUB_USER = "coldoutt";
    const GITHUB_REPO = "web";
    const BRANCH = "main";
    const RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/photo`;

    const circle = document.getElementById('progress-circle');
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = circumference;

    function setProgress(percent) {
      circle.style.strokeDashoffset = circumference - (percent / 100) * circumference;
    }

    async function initSite() {
      const container = document.getElementById('years-container');
      try {
        const response = await fetch(`data.json?v=${new Date().getTime()}`);
        const data = await response.json();
        const years = Object.keys(data).sort((a, b) => b - a);

        years.forEach(year => {
          const navLink = document.createElement('a');
          navLink.href = `#year-${year}`;
          navLink.innerText = year;
          navLink.className = "hover:text-white transition-colors cursor-pointer";
          document.getElementById('nav-years').appendChild(navLink);

          const section = document.createElement('section');
          section.id = `year-${year}`;
          section.className = 'mb-24 reveal';
          
          const tripsHtml = data[year].map(trip => {
            const folderNum = trip.folder.split('_')[0];
            const randomIdx = Math.floor(Math.random() * trip.count) + 1;
            const photoNum = String(randomIdx).padStart(2, '0');
            const fileName = `${year}_${folderNum}_${photoNum}.jpg`;
            const coverUrl = `${RAW_BASE}/${year}/${trip.folder}/${fileName}`;
            
            return `
              <div onclick="openGallery('${trip.title}', '${year}', '${trip.folder}', '${folderNum}', ${trip.count})" class="group cursor-pointer">
                <div class="aspect-[4/5] bg-zinc-900 overflow-hidden mb-1 relative block">
                  <img src="${coverUrl}" class="object-cover w-full h-full grayscale group-hover:grayscale-0 transition-all duration-1000">
                </div>
                <h3 class="text-white text-3xl font-thin lowercase tracking-tighter opacity-60 group-hover:opacity-100 transition-opacity duration-500 leading-tight">${trip.title}</h3>
              </div>
            `;
          }).join('');

          section.innerHTML = `<div class="border-b border-zinc-900 pb-2 mb-10"><h2 class="text-5xl md:text-6xl font-extralight text-white tracking-tighter">${year}</h2></div>
                               <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">${tripsHtml}</div>`;
          container.appendChild(section);
        });

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('active'); });
        }, { threshold: 0.1 });
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
      } catch (e) { console.error(e); }
    }

    async function openGallery(title, year, folderFull, folderNum, count) {
      const grid = document.getElementById('gallery-grid');
      const loader = document.getElementById('loader-container');
      
      grid.innerHTML = '';
      document.getElementById('gallery-title').innerText = title;
      setProgress(0);
      loader.classList.remove('opacity-0');
      document.getElementById('gallery-overlay').classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      // Для сохранения порядка Masonry, мы загружаем всё и вставляем последовательно
      for (let i = 1; i <= count; i++) {
        const photoNum = String(i).padStart(2, '0');
        const fileName = `${year}_${folderNum}_${photoNum}.jpg`;
        const imgUrl = `${RAW_BASE}/${year}/${folderFull}/${fileName}`;
        
        await new Promise((resolve) => {
          const img = new Image();
          img.src = imgUrl;
          img.className = 'opacity-0 transition-opacity duration-700 cursor-zoom-in';
          
          img.onload = () => {
            const item = document.createElement('div');
            item.className = 'photo-item';
            item.appendChild(img);
            grid.appendChild(item);
            
            // Плавное появление
            setTimeout(() => img.classList.replace('opacity-0', 'opacity-60'), 10);
            img.classList.add('hover:opacity-100');
            img.onclick = () => openLightbox(imgUrl);
            
            setProgress((i / count) * 100);
            resolve();
          };
          img.onerror = () => resolve(); // Пропускаем битые фото
        });
      }
      setTimeout(() => loader.classList.add('opacity-0'), 800);
    }

    function closeGallery() { 
      document.getElementById('gallery-overlay').classList.add('hidden'); 
      document.body.style.overflow = 'auto';
    }
    
    function openLightbox(src) { 
      document.getElementById('lightbox-img').src = src; 
      document.getElementById('lightbox').classList.add('active'); 
    }
    
    function closeLightbox() { 
      document.getElementById('lightbox').classList.remove('active'); 
    }

    initSite();
  </script>
</body>
</html>